<!doctype html><html lang=en><head><title>gRPC :: Lambda</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="實做一個可以寄信的 gRPC Proto 寫一個寄發信件服務所需要的資料格式 Proto 是一個文件用來儲存 gRPC server 與 client 交換資料時鎖需要的資料格式，建議可以看看它與 JSON 的對照表來迅速了解需要怎樣寫
syntax = &amp;#34;proto3&amp;#34;; // use proto version 3 package pb; // package name /* Add the Send function for use */ service Mail{ rpc Send (MailRequest) returns (MailStatus) {} } /* Declare what data you need to let server know and server will use it to send a mail */ message MailRequest{ string from = 1; repeated string to = 2; repeated string cc = 3; string subject = 4; string body = 5; string type = 6; } /* Means what the mail status be send or not */ message MailStatus{ int32 status = 1; string code = 2; } 產生 golang 的程式 go get -u github."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/blog/grpc/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="gRPC"><meta property="og:description" content="實做一個可以寄信的 gRPC Proto 寫一個寄發信件服務所需要的資料格式 Proto 是一個文件用來儲存 gRPC server 與 client 交換資料時鎖需要的資料格式，建議可以看看它與 JSON 的對照表來迅速了解需要怎樣寫
syntax = &amp;#34;proto3&amp;#34;; // use proto version 3 package pb; // package name /* Add the Send function for use */ service Mail{ rpc Send (MailRequest) returns (MailStatus) {} } /* Declare what data you need to let server know and server will use it to send a mail */ message MailRequest{ string from = 1; repeated string to = 2; repeated string cc = 3; string subject = 4; string body = 5; string type = 6; } /* Means what the mail status be send or not */ message MailStatus{ int32 status = 1; string code = 2; } 產生 golang 的程式 go get -u github."><meta property="og:url" content="/blog/grpc/"><meta property="og:site_name" content="Lambda"><meta property="og:image" content="img/favicon/%!s().png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="golang"><meta property="article:section" content="gRPC"><meta property="article:published_time" content="2018-11-18 00:00:00 +0000 UTC"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Lambda</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/blog/grpc/>gRPC</a></h1><div class=post-meta><time class=post-date>2018-11-18 ::</time>
<span class=post-author>lambda@lambda.tw</span></div><span class=post-tags>#<a href=/tags/golang/>golang</a>&nbsp;
#<a href=/tags/grpc/>gRPC</a>&nbsp;</span><div class=post-content><div><h1 id=實做一個可以寄信的-grpc>實做一個可以寄信的 gRPC<a href=#實做一個可以寄信的-grpc class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=proto>Proto<a href=#proto class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=寫一個寄發信件服務所需要的資料格式>寫一個寄發信件服務所需要的資料格式<a href=#寫一個寄發信件服務所需要的資料格式 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Proto 是一個文件用來儲存 gRPC server 與 client 交換資料時鎖需要的資料格式，建議可以看看它與 JSON 的<a href=https://developers.google.com/protocol-buffers/docs/proto3#json>對照表</a>來迅速了解需要怎樣寫</p><pre tabindex=0><code class=language-proto3 data-lang=proto3>syntax = &#34;proto3&#34;; // use proto version 3

package pb; // package name

/*
Add the Send function for use
*/
service Mail{
    rpc Send (MailRequest) returns (MailStatus) {}
}

/*
Declare what data you need to let server know
and server will use it to send a mail
*/
message MailRequest{
    string from = 1;
    repeated string to = 2;
    repeated string cc = 3;
    string subject = 4;
    string body = 5;
    string type = 6;
}

/*
Means what the mail status
be send or not
*/
message MailStatus{
    int32 status = 1;
    string code = 2;
}
</code></pre><h3 id=產生-golang-的程式>產生 golang 的程式<a href=#產生-golang-的程式 class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>go get -u github.com/golang/protobuf/protoc-gen-go
protoc --go_out=plugins=grpc:. *.proto
</code></pre><h3 id=觀察產生出來的檔案>觀察產生出來的檔案<a href=#觀察產生出來的檔案 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>可以看到 MailRequest 直接幫你轉換成 golang 的 struct，還多了一些奇怪的東西，但是我們只要知道以後不管是 client 還是 server 都可以用這一些定義好的 <code>protocol</code> 來 import 來使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MailRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>From</span>                 <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`protobuf:&#34;bytes,1,opt,name=from,proto3&#34; json:&#34;from,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>To</span>                   []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`protobuf:&#34;bytes,2,rep,name=to,proto3&#34; json:&#34;to,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Cc</span>                   []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`protobuf:&#34;bytes,3,rep,name=cc,proto3&#34; json:&#34;cc,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Subject</span>              <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`protobuf:&#34;bytes,4,opt,name=subject,proto3&#34; json:&#34;subject,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Body</span>                 <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`protobuf:&#34;bytes,5,opt,name=body,proto3&#34; json:&#34;body,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Type</span>                 <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`protobuf:&#34;bytes,6,opt,name=type,proto3&#34; json:&#34;type,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>XXX_NoUnkeyedLiteral</span> <span style=color:#66d9ef>struct</span>{} <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>XXX_unrecognized</span>     []<span style=color:#66d9ef>byte</span>   <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>XXX_sizecache</span>        <span style=color:#66d9ef>int32</span>    <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=server>Server<a href=#server class=hanchor arialabel=Anchor>&#8983;</a></h2><p>這邊我們就可以<code>實做</code>一個可以寄信的服務 (此處使用 gomail 套件))</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;golang.org/x/net/context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;myMail/pb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gomail</span> <span style=color:#e6db74>&#34;gopkg.in/gomail.v2&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>server</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ch</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gomail</span>.<span style=color:#a6e22e>Message</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>Send is a simple function for send email
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>server</span>) <span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>mail</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>MailRequest</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>MailStatus</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomail</span>.<span style=color:#a6e22e>NewMessage</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SetHeader</span>(<span style=color:#e6db74>&#34;From&#34;</span>, <span style=color:#a6e22e>mail</span>.<span style=color:#a6e22e>From</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SetHeader</span>(<span style=color:#e6db74>&#34;To&#34;</span>, <span style=color:#a6e22e>mail</span>.<span style=color:#a6e22e>To</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SetHeader</span>(<span style=color:#e6db74>&#34;Subject&#34;</span>, <span style=color:#a6e22e>mail</span>.<span style=color:#a6e22e>Subject</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>SetBody</span>(<span style=color:#a6e22e>mail</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>mail</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>MailStatus</span>{<span style=color:#a6e22e>Status</span>: int32(<span style=color:#ae81ff>0</span>), <span style=color:#a6e22e>Code</span>: <span style=color:#e6db74>&#34;&#34;</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 監聽 50051 port
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lis</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Listen</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;:50051&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;無法監聽該埠口：%v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>NewServer</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>RegisterMailServer</span>(<span style=color:#a6e22e>s</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>server</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>reflection</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomail</span>.<span style=color:#a6e22e>NewDialer</span>(<span style=color:#e6db74>&#34;smtp.gmail.com&#34;</span>, <span style=color:#ae81ff>587</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;GMAIL_ACC&#34;</span>), <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;GMAIL_PASS&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#a6e22e>gomail</span>.<span style=color:#a6e22e>SendCloser</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>open</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>m</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>:
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>open</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Dial</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>open</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomail</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>m</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Print</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Close the connection to the SMTP server if no email was sent in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// the last 30 seconds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>):
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>open</span> {
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Close</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>						panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>open</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Serve</span>(<span style=color:#a6e22e>lis</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;無法提供服務：%v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=client>Client<a href=#client class=hanchor arialabel=Anchor>&#8983;</a></h2><p>我們希望 client 模擬一般會用到的 http 服務，但是我們不寫邏輯在裡面，就瀏覽就呼叫 server 寄信了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;myMail/pb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 連線到遠端 gRPC 伺服器。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;server:50051&#34;</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;連線失敗：%v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 建立新的 Mail 客戶端，所以等一下就能夠使用 Mail 的所有方法。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>NewMailClient</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 傳送新請求到遠端 gRPC 伺服器 Mail 中，並呼叫 Send 函式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>MailRequest</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>From</span>:    <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;MAIL_FROM&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>To</span>:      []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;abc@example.com&#34;</span>},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Cc</span>:      []<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subject</span>: <span style=color:#e6db74>&#34;How to use gRPC&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Body</span>:    <span style=color:#e6db74>&#34;Just done&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Type</span>:    <span style=color:#e6db74>&#34;text/html&#34;</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/send&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ret</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Send</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mr</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;無法執行 Send 函式：%v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Send %s&#34;</span>, <span style=color:#a6e22e>ret</span>.<span style=color:#a6e22e>Code</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=中場休息>中場休息<a href=#中場休息 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>看看我們目錄們現在長怎樣</p><pre tabindex=0><code class=language-shell-script data-lang=shell-script>tree myMail
.
├── client
│   └── main.go
├── pb
│   ├── mail.pb.go
│   └── mail.proto
└── server
    └── main.go
</code></pre><p>我們可能有幾種管理方式</p><ul><li>可以看出來我們現在其實可以拆開成為三個 git repo
一個是 client 一個是 server 一個是 pb 由團隊們共同協同修改 pb 由個人或團隊維護單一個或多個 client(可能是某商業應用)，再由個人或一個團隊維護 server (實做單純的 mail service)，此時 pb 的修改將會關忽到所有人、client 的修改不會動到 mail serice，此時 mail service 團隊如果想要修改訊息格式必須要交給 pb 團隊去實現或是交付 PR 給 pb 團隊</li><li>但是如果把 mail service 的 pb 單獨綁到 server 這個專案，使得最後只有 client(1~*) & server(1) 個 repo 將會發生以下事情，client 只需要安裝 pb 但是卻要把整個 service 下載下來，就算 golang 不會幫你 compiled 沒用到的東西，但是在 CI/CD 時還是會去下載那些用不到的玩意兒，在第一次使用以及後來 service 有更新時都會影響整個部屬時間</li></ul><p>故在此我覺得第一個方案比較妥當，也比較符合 micro service 的感覺</p><h2 id=dockerize>Dockerize<a href=#dockerize class=hanchor arialabel=Anchor>&#8983;</a></h2><p>其實就是包成 Docker</p><h3 id=dockerfile>Dockerfile<a href=#dockerfile class=hanchor arialabel=Anchor>&#8983;</a></h3><p>這裡很懶惰的接受參數後 build <code>client</code> or <code>server</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span>cat Dockerfile<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang AS build-env</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> BUILD_PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> . /go/src/myMail<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /go/src/myMail/$BUILD_PATH <span style=color:#f92672>&amp;&amp;</span> go get <span style=color:#f92672>&amp;&amp;</span> GOOS<span style=color:#f92672>=</span>linux GOARCH<span style=color:#f92672>=</span>amd64 CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> go build -o app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> BUILD_PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> EXPOSE_PROT<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>build-env /go/src/myMail/$BUILD_PATH/app /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk update <span style=color:#f92672>&amp;&amp;</span> apk add ca-certificates <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/cache/apk/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> ${EXPOSE_PROT}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 50051, 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=build>Build<a href=#build class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>docker build \
--build-arg BUILD_PATH=server \
--build-arg EXPOSE_PROT=50051 \
-t mailserver .
</code></pre><pre tabindex=0><code class=language-shell-script data-lang=shell-script>docker build \
--build-arg BUILD_PATH=client \
--build-arg EXPOSE_PROT=8080 \
-t mailclient .
</code></pre><h2 id=k8s>K8s<a href=#k8s class=hanchor arialabel=Anchor>&#8983;</a></h2><p>拆拆拆，拆成 micro service 以後部屬變成麻煩，資料傳遞的網路也變成麻煩，K8s 可能可以幫我們少點這種麻煩，但是還不夠，這裡只的範例只其實架構還是爛爛的，少了很多微服務必要的元件，如： message queue, circuit breaker, API route&mldr;</p><pre tabindex=0><code class=language-kubernetes data-lang=kubernetes>kind: Service
apiVersion: v1
metadata:
  name:  server
spec:
  selector:
    app:  server
  ports:
  - port:  50051
    protocol: TCP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: server-depolyment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: server
  template:
    metadata:
      labels:
        app: server
    spec:
      containers:
      - name: server
        image: mailserver
        ports:
        - containerPort: 50051
        env:
	- name: GMAIL_ACC
          valueFrom:
            secretKeyRef:
              name: gmail-acc
              key: env
        - name: GMAIL_PASS
          valueFrom:
            secretKeyRef:
              name: gmail-pass
              key: env
</code></pre><pre tabindex=0><code class=language-kubernetes data-lang=kubernetes>kind: Service
apiVersion: v1
metadata:
  name:  client
spec:
  selector:
    app:  client
  type:  NodePort
  ports:
  - port:  8080
    nodePort: 30290
    protocol: TCP
    targetPort:  8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-depolyment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: client
  template:
    metadata:
      labels:
        app: client
    spec:
      containers:
      - name: client
        image: mailclient
        ports:
        - containerPort: 8080
        env:
	- name: MAIL_FROM
          valueFrom:
            secretKeyRef:
              name: gmail-acc
              key: env
</code></pre><h3 id=try-it>Try it<a href=#try-it class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>kubectl -f server.yaml
kubectl -f client.yaml
</code></pre></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-khfo0axv59.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>