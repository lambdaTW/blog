<!doctype html><html lang=en><head><title>Python Project (3) Test Your Project :: Lambda</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Test your project"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/blog/python-project-3/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Python Project (3) Test Your Project"><meta property="og:description" content="Test your project"><meta property="og:url" content="/blog/python-project-3/"><meta property="og:site_name" content="Lambda"><meta property="og:image" content="img/favicon/%!s().png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="python"><meta property="article:section" content="project"><meta property="article:section" content="test"><meta property="article:published_time" content="2021-04-24 00:00:00 +0000 UTC"></head><body><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/>Home</a></li><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/blog/python-project-3/>Python Project (3) Test Your Project</a></h1><div class=post-meta><time class=post-date>2021-04-24 ::</time>
<span class=post-author>lambda@lambda.tw</span></div><span class=post-tags>#<a href=/tags/python/>python</a>&nbsp;
#<a href=/tags/project/>project</a>&nbsp;
#<a href=/tags/test/>test</a>&nbsp;</span><div class=post-content><div><h1 id=test>Test<a href=#test class=hanchor arialabel=Anchor>&#8983;</a></h1><p>寫測試可以減少改壞以前的東西，加速開發，在原生的 Python 就有提供測試的方法 <a href=https://docs.python.org/3/library/unittest.html><code>unittest</code></a>，然而隨著越來越多的套件支援與其脫鉤，如果是開新專案，可以試著從一開始就使用 <a href=https://github.com/pytest-dev/pytest><code>pytest</code></a></p><h2 id=pytest>Pytest<a href=#pytest class=hanchor arialabel=Anchor>&#8983;</a></h2><p>該套件支援簡單的測試方法，多個套件支援其測試，例如在寫 <code>Django Channels</code> 時異步測試就推薦使用 <code>pytest</code> 可以支援其異步測試，該套件也支援 <code>pyproject.toml</code> 當作設定檔</p><h3 id=usage>Usage<a href=#usage class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>pip install pytest

pytest tests
=================================================== test session starts ===================================================
platform darwin -- Python 3.8.5, pytest-6.2.3, py-1.10.0, pluggy-0.13.1 -- /Users/super/project/prj/venv/bin/python3
cachedir: .pytest_cache
django: settings: settings (from ini)
rootdir: /Users/super/project/prj, configfile: pyproject.toml
plugins: cov-2.11.1, django-4.1.0
collected 26 items

Creating test database for alias &#39;default&#39;...
tests/test_admin/test_actions.py::TestCreateTransformationAction::test_transformation_action_check_fk_values PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_nodes_will_be_copied PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_transitions_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_nodes_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_transitions_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_deep_inner_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_diagram_will_create_static_diagram PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_diagram_with_inner_diagram PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_node_will_take_permissions PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_node_will_take_updateable_fields PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_transformation_will_take_all_things PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_uuid_pk_mode PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_deep_enter PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_deep_leave PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_leave_inner_deep_will_not_present PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_inner_forward_node_will_check_forward_number PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_node_with_inner_will_create_init_nodes_present PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_rollback_will_create_outer_rollback_node_present PASSED
tests/test_models/test_nodes.py::TestFreeze::test_enter_node_will_change_present_node PASSED
tests/test_models/test_permissions.py::TestFreeze::test_get_permission_pks PASSED
tests/test_utils/test_context_utils.py::TestIterKeys::test_simple_case PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_deep_comparison PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_has_attribute PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_simple_case PASSED
Destroying test database for alias &#39;default&#39;...
</code></pre><h3 id=configuration>Configuration<a href=#configuration class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># pyproject.toml</span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>pytest</span>.<span style=color:#a6e22e>ini_options</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>addopts</span> = <span style=color:#e6db74>&#34;--tb=short -p no:warnings -s -v -ra&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DJANGO_SETTINGS_MODULE</span> = <span style=color:#e6db74>&#34;settings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -- recommended but optional:</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>python_files</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;tests.py&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test_*.py&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*_tests.py&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h2 id=coverage>Coverage<a href=#coverage class=hanchor arialabel=Anchor>&#8983;</a></h2><p>跑了測試還不夠，為了要知道哪些程式碼有被測試到，甚至是哪些程式碼被哪些測試程式測試，我們可以使用 <code>coverage</code> 套件來達成，該套件也支援 <code>pyproject.toml</code></p><h3 id=normal-usage>Normal usage<a href=#normal-usage class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>pip install coverage
python -m unittest discover
</code></pre><h3 id=integrate-with-pytest>Integrate with pytest<a href=#integrate-with-pytest class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code>pip install coverage
coverage run --source=prj -m pytest
coverage report -m
Name                              Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------------------------------------------------------
prj/__init__.py                       1      0      0      0   100%
prj/admin/__init__.py                28      9      2      0    63%   17-35
prj/admin/actions.py                 64     33     14      1    44%   14-&gt;30, 44-58, 61-82, 103-122
prj/admin/base.py                    47     47     14      0     0%   1-95
prj/admin/helpers.py                 18     11      4      0    32%   8, 13, 18-19, 22-32
prj/apps.py                           3      3      0      0     0%   1-5
prj/models.py                       195      7     67      5    95%   24, 45, 65, 121, 129, 239-&gt;238, 373-&gt;376, 381-&gt;390, 422, 458
prj/tests/__init__.py                 0      0      0      0   100%
prj/utils/__init__.py                 0      0      0      0   100%
prj/utils/ast_parser_utils.py        16      0     10      1    96%   27-&gt;exit
prj/utils/rule_context_utils.py       7      1      4      2    73%   9
----------------------------------------------------------------------------------------------------------------------------
TOTAL                               379    111    115      9    70%
</code></pre><h3 id=configuration-1>Configuration<a href=#configuration-1 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># pyproject.toml</span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>coverage</span>.<span style=color:#a6e22e>report</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>exclude_lines</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;pragma: no cover&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;def __repr__&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;if __name__ == .__main__.:&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;nocov&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;if TYPE_CHECKING:&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>coverage</span>.<span style=color:#a6e22e>run</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># Activating branch coverage is super important</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>branch</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>omit</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*/migrations/*&#34;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;prj&#34;</span>
</span></span></code></pre></div><h2 id=pytest-cov>pytest-cov<a href=#pytest-cov class=hanchor arialabel=Anchor>&#8983;</a></h2><p>為了讓 pytest 執行時不要那麼麻煩改用 <code>coverage</code>，我們使用該套件去讓 <code>pytest</code> 直接整合 <code>coverage</code> 以後寫測試就只要下 <code>pytest --cov=prj</code> 就好了</p><h3 id=usage-1>Usage<a href=#usage-1 class=hanchor arialabel=Anchor>&#8983;</a></h3><pre tabindex=0><code class=language-shell-script data-lang=shell-script>pip install pytest-cov
pytest --cov=prj
=================================================== test session starts ===================================================
platform darwin -- Python 3.8.5, pytest-6.2.3, py-1.10.0, pluggy-0.13.1 -- /Users/super/project/prj/venv/bin/python3
cachedir: .pytest_cache
django: settings: settings (from ini)
rootdir: /Users/super/project/prj, configfile: pyproject.toml
plugins: cov-2.11.1, django-4.1.0
collected 26 items


Creating test database for alias &#39;default&#39;...
tests/test_admin/test_actions.py::TestCreateTransformationAction::test_transformation_action_check_fk_values PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_nodes_will_be_copied PASSED
tests/test_models/test_copy.py::TestInnerCopy::test_copy_to_new_diagram_transitions_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_nodes_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_copy_to_new_diagram_transitions_will_be_copied PASSED
tests/test_models/test_copy.py::TestDeepCopy::test_deep_inner_copy_to_new_diagram_inner_attr_are_copied PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_diagram_will_create_static_diagram PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_diagram_with_inner_diagram PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_node_will_take_permissions PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_node_will_take_updateable_fields PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_transformation_will_take_all_things PASSED
tests/test_models/test_freeze.py::TestFreeze::test_freeze_uuid_pk_mode PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_deep_enter PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_deep_leave PASSED
tests/test_models/test_inner_enter.py::TestDeepInnerEnter::test_leave_inner_deep_will_not_present PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_inner_forward_node_will_check_forward_number PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_node_with_inner_will_create_init_nodes_present PASSED
tests/test_models/test_inner_enter.py::TestInnerEnter::test_enter_rollback_will_create_outer_rollback_node_present PASSED
tests/test_models/test_nodes.py::TestFreeze::test_enter_node_will_change_present_node PASSED
tests/test_models/test_permissions.py::TestFreeze::test_get_permission_pks PASSED
tests/test_utils/test_context_utils.py::TestIterKeys::test_simple_case PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_deep_comparison PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_has_attribute PASSED
tests/test_utils/test_parser_utils.py::TestIterKeys::test_simple_case PASSED
Destroying test database for alias &#39;default&#39;...


---------- coverage: platform darwin, python 3.8.5-final-0 -----------
Name                              Stmts   Miss Branch BrPart  Cover
----------------------------------------------------------------------
prj/__init__.py                       1      0      0      0   100%
prj/admin/__init__.py                28      9      2      0    63%
prj/admin/actions.py                 64     33     14      1    44%
prj/admin/base.py                    47     47     14      0     0%
prj/admin/helpers.py                 18     11      4      0    32%
prj/apps.py                           3      3      0      0     0%
prj/models.py                       195      7     67      5    95%
prj/tests/__init__.py                 0      0      0      0   100%
prj/utils/__init__.py                 0      0      0      0   100%
prj/utils/ast_parser_utils.py        16      0     10      1    96%
prj/utils/rule_context_utils.py       7      1      4      2    73%
----------------------------------------------------------------------
TOTAL                               379    111    115      9    70%
</code></pre><h3 id=configuration-2>Configuration<a href=#configuration-2 class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e># pyproject.toml</span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>tool</span>.<span style=color:#a6e22e>pytest</span>.<span style=color:#a6e22e>ini_options</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># 多加一個參數即可</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>addopts</span> = <span style=color:#e6db74>&#34;--tb=short -p no:warnings -s -v -ra --cov=prj&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>DJANGO_SETTINGS_MODULE</span> = <span style=color:#e6db74>&#34;settings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -- recommended but optional:</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>python_files</span> = [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;tests.py&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;test_*.py&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;*_tests.py&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span></code></pre></div></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>