<!doctype html><html lang=en><head><title>Chick-Fil-A Architecture :: Lambda</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本篇介紹美國連鎖速食業，從 Docker 到 Kubernetes，在千家商店使用的混合雲架構的演化"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/blog/architecture-chick-fil-a/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=/img/theme-colors/orange.png><link rel=apple-touch-icon href=/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Chick-Fil-A Architecture"><meta property="og:description" content="本篇介紹美國連鎖速食業，從 Docker 到 Kubernetes，在千家商店使用的混合雲架構的演化"><meta property="og:url" content="/blog/architecture-chick-fil-a/"><meta property="og:site_name" content="Lambda"><meta property="og:image" content="http://www.chick-fil-a.com/-/media/images/cfacom/default-images/chick-fil-a-logo-vector.ashx"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:section" content="architecture"><meta property="article:published_time" content="2022-11-12 14:22:22 +0800 +0800"></head><body><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Lambda</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/blog/>Blog</a></li><li><a href=/categories/>Categories</a></li><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=/blog/architecture-chick-fil-a/>Chick-Fil-A Architecture</a></h1><div class=post-meta><time class=post-date>2022-11-12 ::</time></div><span class=post-tags>#<a href=/tags/architecture/>architecture</a>&nbsp;</span>
<img src=http://www.chick-fil-a.com/-/media/images/cfacom/default-images/chick-fil-a-logo-vector.ashx class=post-cover alt="Chick-Fil-A Architecture" title="Cover Image"><div class=post-content><div><h2 id=簡介>簡介<a href=#簡介 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Chick-fil-A 是一間總部位於美國喬治亞州 College Park 的美式連鎖速食店，以雞肉三明治為主 (圖片看起來其實是漢堡) ，目前有超過 2,200 間連鎖餐廳</p><h2 id=2017-架構>2017 架構<a href=#2017-架構 class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>在這個階段已經有 MQTT 作為訊息傳遞</li><li>運用 Docker 去做大部分的事情，使用 Docker Swarm</li><li>使用 Fluentd 做 Event & Log Forwarding<ul><li>MQTT</li><li>Docker log</li></ul></li><li>Redis cluster 作為 Persistence 層</li></ul><p><img src=https://res.infoq.com/presentations/chick-fil-a-k8-clusters/en/slides/sl5-1531966648307.jpg alt="Chick-Fil-A 2017 Architecture"></p><h3 id=iot>IoT<a href=#iot class=hanchor arialabel=Anchor>&#8983;</a></h3><p><img src=https://res.infoq.com/presentations/chickfila-iot/en/slides/sl16-1515812662954.jpg alt="Bring IoT up">
<img src=https://res.infoq.com/presentations/chickfila-iot/en/slides/sl31-1515812667345.jpg alt=OAuth></p><ul><li>透過 OAuth 流程，註冊 IoT (包含人工流程)</li><li>利用 Local OAuth 來達到本地認證，除了第一次啟動 IoT 設備以外，IoT 本人就不用再連接到網際網路也可以進行 refresh token</li></ul><p><img src=https://res.infoq.com/presentations/chickfila-iot/en/slides/sl20-1515812665143.jpg alt=MQTT></p><ul><li>獲取 JWT Token 以後都透過 MQTT broker 進行溝通</li></ul><h3 id=deployment-flow>Deployment flow<a href=#deployment-flow class=hanchor arialabel=Anchor>&#8983;</a></h3><p><img src=https://res.infoq.com/presentations/chickfila-iot/en/slides/sl35-1515812668341.jpg alt="Deployment Flow 2017"></p><h2 id=2018-架構>2018 架構<a href=#2018-架構 class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>改用 K8s</li><li>因為 K8s 可以更簡單的用 Prometheus 做監控</li><li>用 Fleet 去做部署</li></ul><p><img src=https://res.infoq.com/presentations/chick-fil-a-k8-clusters/en/slides/sl6-1531966652646.jpg alt="Chick-Fil-A 2018 Architecture"></p><h2 id=equirements>Equirements<a href=#equirements class=hanchor arialabel=Anchor>&#8983;</a></h2><blockquote><p>3 NCU with Quadcore processor, 8 GB RAM, SSD</p></blockquote><p><img src=https://res.infoq.com/presentations/chick-fil-a-k8-clusters/en/slides/sl11-1531966645373.jpg alt=Equirements></p><h2 id=goals>Goals<a href=#goals class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>非工程人員也可以簡單安裝</li><li>可以遠端管理</li><li>可以自動發現已經安裝的裝置和裝置上的 K8s 叢集</li><li>可以自己恢復，可以做到 HA</li></ul><h2 id=bare-metal-cluster-k8s-at-scale>Bare Metal Cluster K8s at scale<a href=#bare-metal-cluster-k8s-at-scale class=hanchor arialabel=Anchor>&#8983;</a></h2><p><img src=https://res.infoq.com/presentations/chick-fil-a-k8-clusters/en/slides/sl14-1531966652381.jpg alt="Bare Metal Cluster K8s at scale"></p><h3 id=highlander>Highlander<a href=#highlander class=hanchor arialabel=Anchor>&#8983;</a></h3><p>為了解決三台機器在內網，開機時要找到誰當 K8s cluster 的 Leader，Chick-Fil-A 自己做了這個工具去</p><ul><li>確認誰是老大</li><li>執行 RKE</li><li>安裝一些基本的 Pods (ex: Istio&mldr;)</li></ul><h3 id=resetting-cluster-state>Resetting Cluster State<a href=#resetting-cluster-state class=hanchor arialabel=Anchor>&#8983;</a></h3><p>當機器有任何問題時，透過 OverlayFS 讓遠端可以去清除機器 (回到 Golden image 的狀態)</p><h3 id=hooves-uphttpsgithubcomchick-fil-ahoovesup><a href=https://github.com/chick-fil-a/hoovesup>Hooves Up</a><a href=#hooves-uphttpsgithubcomchick-fil-ahoovesup class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Chick-Fil-A 自己做的 Ansible 工具，當機器啟動時，可以自動註冊到 AWS SSM</p><h3 id=fleet>Fleet<a href=#fleet class=hanchor arialabel=Anchor>&#8983;</a></h3><p>為了要部署到全部的店家中，Chick-Fil-A 遇到了幾個問題</p><ul><li>如果有一千的叢集，部署中有 900 個部署成功，另外 100 個失敗，那要<ul><li>全部 rollback?</li><li>手動解決並且處理掉那 100 個失敗?</li></ul></li></ul><p>最後他們建立了 Fleet 來做部署，這邊他們使用現有的 message broker (MQTT & Amazon SQS)，來通知地端的 Cluster 去做部署</p><blockquote><p>Fleet Ecosystem Components</p></blockquote><ul><li>Fleet Client</li><li>Fleet Server API<ul><li>產生部署需要的 k8s yaml</li><li>管理 Cluster 的 Git</li><li>部署狀態監控</li></ul></li><li>Atlas<ul><li>存放已經測試過的 k8s yaml</li></ul></li><li>Vessel<ul><li>放在店家的 Agent 用來做部署</li></ul></li><li>Dashboards</li></ul><h2 id=entire-flow>Entire Flow<a href=#entire-flow class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li>在工程機房<ul><li>使用 Golden image 去安裝系統，內建 Ansible</li></ul></li><li>運送機器</li><li>店家<ul><li>安裝人員打開機器</li><li>Sherlock 運行，確認在店內網路，並且信任機器</li><li>Highlander，找到叢集需要的三台機器運行 RKE</li><li>每台機器個別註冊 AWS SSM (運用 Hooves Up)</li><li>MQTT 通知 Fleet Vessel 自動從線上抓軟體並且部署</li></ul></li></ul><h2 id=ref>Ref<a href=#ref class=hanchor arialabel=Anchor>&#8983;</a></h2><ul><li><a href=https://www.infoq.com/presentations/chick-fil-a-k8-clusters/>Chick-Fil-A-K8-Clusters</a></li><li><a href=https://www.infoq.com/presentations/chickfila-iot/>Chick-Fil-A-IoT</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/blog/aha/><span class=button__icon>←</span>
<span class=button__text>Chick-Fil-A AHA</span></a></span>
<span class="button next"><a href=/blog/aws-architecture-quantiphi/><span class=button__text>AWS Architecture Quantiphi Real-Time Call Analytics</span>
<span class=button__icon>→</span></a></span></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-khfo0axv59.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>