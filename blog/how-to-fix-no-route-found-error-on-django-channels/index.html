<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>How to fix no route found error on Django Channels | Lambda</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Issue description Django Channels 對於不存在的路徑存取，全部會拋出錯誤，而不是一般性的警告處理，所以如果和我一樣在 Djangoo Channels 有裝上 Sentry ，而且伺服器在被惡意嘗試路徑時就會看到一堆 ValueError: No route found for path '...'. 的錯誤資訊，好處是知道被打了，壞處就是會噴錢（如果不是自己 Hosting）。
Fix it Make HandleRouteNotFoundMiddleware for this issue from datetime import datetime from logging import getLogger from django.urls.exceptions import Resolver404 logger = getLogger(__file__) class HandleRouteNotFoundMiddleware: def __init__(self, inner): self.inner = inner def __call__(self, scope): try: inner_instance = self.inner(scope) return inner_instance except (Resolver404, ValueError) as e: if 'No route found for path' not in str(e) and \ scope[&#34;type&#34;] not in ['http', 'websocket']: raise e logger."><meta name=generator content="Hugo 0.104.3"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="How to fix no route found error on Django Channels"><meta property="og:description" content="Issue description Django Channels 對於不存在的路徑存取，全部會拋出錯誤，而不是一般性的警告處理，所以如果和我一樣在 Djangoo Channels 有裝上 Sentry ，而且伺服器在被惡意嘗試路徑時就會看到一堆 ValueError: No route found for path '...'. 的錯誤資訊，好處是知道被打了，壞處就是會噴錢（如果不是自己 Hosting）。
Fix it Make HandleRouteNotFoundMiddleware for this issue from datetime import datetime from logging import getLogger from django.urls.exceptions import Resolver404 logger = getLogger(__file__) class HandleRouteNotFoundMiddleware: def __init__(self, inner): self.inner = inner def __call__(self, scope): try: inner_instance = self.inner(scope) return inner_instance except (Resolver404, ValueError) as e: if 'No route found for path' not in str(e) and \ scope[&#34;type&#34;] not in ['http', 'websocket']: raise e logger."><meta property="og:type" content="article"><meta property="og:url" content="/blog/how-to-fix-no-route-found-error-on-django-channels/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-01-25T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-25T00:00:00+00:00"><meta itemprop=name content="How to fix no route found error on Django Channels"><meta itemprop=description content="Issue description Django Channels 對於不存在的路徑存取，全部會拋出錯誤，而不是一般性的警告處理，所以如果和我一樣在 Djangoo Channels 有裝上 Sentry ，而且伺服器在被惡意嘗試路徑時就會看到一堆 ValueError: No route found for path '...'. 的錯誤資訊，好處是知道被打了，壞處就是會噴錢（如果不是自己 Hosting）。
Fix it Make HandleRouteNotFoundMiddleware for this issue from datetime import datetime from logging import getLogger from django.urls.exceptions import Resolver404 logger = getLogger(__file__) class HandleRouteNotFoundMiddleware: def __init__(self, inner): self.inner = inner def __call__(self, scope): try: inner_instance = self.inner(scope) return inner_instance except (Resolver404, ValueError) as e: if 'No route found for path' not in str(e) and \ scope[&#34;type&#34;] not in ['http', 'websocket']: raise e logger."><meta itemprop=datePublished content="2020-01-25T00:00:00+00:00"><meta itemprop=dateModified content="2020-01-25T00:00:00+00:00"><meta itemprop=wordCount content="581"><meta itemprop=keywords content="Django,Django Channels,Middleware,"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to fix no route found error on Django Channels"><meta name=twitter:description content="Issue description Django Channels 對於不存在的路徑存取，全部會拋出錯誤，而不是一般性的警告處理，所以如果和我一樣在 Djangoo Channels 有裝上 Sentry ，而且伺服器在被惡意嘗試路徑時就會看到一堆 ValueError: No route found for path '...'. 的錯誤資訊，好處是知道被打了，壞處就是會噴錢（如果不是自己 Hosting）。
Fix it Make HandleRouteNotFoundMiddleware for this issue from datetime import datetime from logging import getLogger from django.urls.exceptions import Resolver404 logger = getLogger(__file__) class HandleRouteNotFoundMiddleware: def __init__(self, inner): self.inner = inner def __call__(self, scope): try: inner_instance = self.inner(scope) return inner_instance except (Resolver404, ValueError) as e: if 'No route found for path' not in str(e) and \ scope[&#34;type&#34;] not in ['http', 'websocket']: raise e logger."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Lambda</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/ title="Home page">Home</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/blog/ title="Blog page">Blog</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/categories/ title="Categories page">Categories</a></li></ul><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">BLOG</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">How to fix no route found error on Django Channels</h1><p class=tracked>By <strong><a href=mailto:lambda@lambda.tw>lambda@lambda.tw</a></strong></p><time class="f6 mv4 dib tracked" datetime=2020-01-25T00:00:00Z>January 25, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id=issue-description>Issue description</h1><p>Django Channels 對於不存在的路徑存取，全部會拋出錯誤，而不是一般性的警告處理，所以如果和我一樣在 Djangoo Channels 有裝上 Sentry ，而且伺服器在被惡意嘗試路徑時就會看到一堆 <code>ValueError: No route found for path '...'.</code> 的錯誤資訊，好處是知道被打了，壞處就是會噴錢（如果不是自己 Hosting）。</p><h1 id=fix-it>Fix it</h1><h2 id=make-handleroutenotfoundmiddleware-for-this-issue>Make <code>HandleRouteNotFoundMiddleware</code> for this issue</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> logging <span style=color:#f92672>import</span> getLogger
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.urls.exceptions <span style=color:#f92672>import</span> Resolver404
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>logger <span style=color:#f92672>=</span> getLogger(__file__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HandleRouteNotFoundMiddleware</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, inner):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>inner <span style=color:#f92672>=</span> inner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, scope):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            inner_instance <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>inner(scope)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> inner_instance
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span> (Resolver404, <span style=color:#a6e22e>ValueError</span>) <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;No route found for path&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> str(e) <span style=color:#f92672>and</span> \
</span></span><span style=display:flex><span>               scope[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> [<span style=color:#e6db74>&#39;http&#39;</span>, <span style=color:#e6db74>&#39;websocket&#39;</span>]:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            logger<span style=color:#f92672>.</span>warning(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>datetime<span style=color:#f92672>.</span>now()<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>e<span style=color:#e6db74>}</span><span style=color:#e6db74> - </span><span style=color:#e6db74>{</span>scope<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> scope[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>handle_http_route_error
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>elif</span> scope[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;websocket&#34;</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>handle_ws_route_error
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_ws_route_error</span>(self, receive, send):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> send({<span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;websocket.close&#34;</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle_http_route_error</span>(self, receive, send):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> send({
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http.response.start&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#ae81ff>404</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;headers&#34;</span>: {},
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> send({
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;http.response.body&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;body&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;more_body&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span></code></pre></div><h2 id=usage>Usage</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>from</span> core.middleware <span style=color:#f92672>import</span> HandleRouteNotFoundMiddleware
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>application <span style=color:#f92672>=</span> ProtocolTypeRouter({
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;websocket&#39;</span>: AuthMiddlewareStack(
</span></span><span style=display:flex><span>        HandleRouteNotFoundMiddleware(
</span></span><span style=display:flex><span>            URLRouter(
</span></span><span style=display:flex><span>                routing<span style=color:#f92672>.</span>websocket_urlpatterns
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;channel&#39;</span>: router,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;http&#39;</span>: HandleRouteNotFoundMiddleware(
</span></span><span style=display:flex><span>        URLRouter(
</span></span><span style=display:flex><span>            urlpatterns
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h1 id=how-it-works>How it works</h1><h2 id=protocoltyperouter>ProtocolTypeRouter</h2><p>首先我們看到在 Django Channels 我們使用的 Router，可以看到在 <code>__init__</code> 時把我們對應表放進去，在被 <code>Call</code> 時直接把 <code>scope</code> 塞到對應的 <code>Instance</code> 一樣是執行該 <code>Instance</code> 的 <code>__call__</code> （或是該物件已經是 Function 可以直接執行）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProtocolTypeRouter</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Takes a mapping of protocol type names to other Application instances,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    and dispatches to the right one based on protocol name (or raises an error)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, application_mapping):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>application_mapping <span style=color:#f92672>=</span> application_mapping
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>application_mapping:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>application_mapping[<span style=color:#e6db74>&#34;http&#34;</span>] <span style=color:#f92672>=</span> AsgiHandler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, scope):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> scope[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>application_mapping:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>application_mapping[scope[<span style=color:#e6db74>&#34;type&#34;</span>]](scope)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;No application configured for scope type </span><span style=color:#e6db74>%r</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> scope[<span style=color:#e6db74>&#34;type&#34;</span>])
</span></span></code></pre></div><h2 id=urlrouter>URLRouter</h2><p>依照上面所述說的，我們常在 <code>Protocol</code> 對應裡面放入 <code>URLRouter</code> 所以我們這裡就只要看 <code>___call__</code> 就好了，可以看到在最後 <code>else</code> 的部份，會拋出兩個錯誤，也是我們這次主要要修正的問題。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>URLRouter</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Routes to different applications/consumers based on the URL path.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Works with anything that has a ``path`` key, but intended for WebSocket
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    and HTTP. Uses Django&#39;s django.conf.urls objects for resolution -
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    url() or path().
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, scope):
</span></span><span style=display:flex><span>        <span style=color:#75715e># Get the path</span>
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> scope<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;path_remaining&#34;</span>, scope<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#66d9ef>None</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> path <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;No &#39;path&#39; key in connection scope, cannot route URLs&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Remove leading / to match Django&#39;s handling</span>
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> path<span style=color:#f92672>.</span>lstrip(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Run through the routes we have until one matches</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> route <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>routes:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>                match <span style=color:#f92672>=</span> route_pattern_match(route, path)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> match:
</span></span><span style=display:flex><span>                    new_path, args, kwargs <span style=color:#f92672>=</span> match
</span></span><span style=display:flex><span>                    <span style=color:#75715e># Add args or kwargs into the scope</span>
</span></span><span style=display:flex><span>                    outer <span style=color:#f92672>=</span> scope<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;url_route&#34;</span>, {})
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> route<span style=color:#f92672>.</span>callback(dict(
</span></span><span style=display:flex><span>                        scope,
</span></span><span style=display:flex><span>                        path_remaining<span style=color:#f92672>=</span>new_path,
</span></span><span style=display:flex><span>                        url_route<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;args&#34;</span>: outer<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;args&#34;</span>, ()) <span style=color:#f92672>+</span> args,
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#34;kwargs&#34;</span>: {<span style=color:#f92672>**</span>outer<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;kwargs&#34;</span>, {}), <span style=color:#f92672>**</span>kwargs},
</span></span><span style=display:flex><span>                        },
</span></span><span style=display:flex><span>                    ))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>except</span> Resolver404 <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;path_remaining&#34;</span> <span style=color:#f92672>in</span> scope:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> Resolver404(<span style=color:#e6db74>&#34;No route found for path </span><span style=color:#e6db74>%r</span><span style=color:#e6db74>.&#34;</span> <span style=color:#f92672>%</span> path)
</span></span><span style=display:flex><span>            <span style=color:#75715e># We are the outermost URLRouter</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#34;No route found for path </span><span style=color:#e6db74>%r</span><span style=color:#e6db74>.&#34;</span> <span style=color:#f92672>%</span> path)
</span></span></code></pre></div><h2 id=middleware>Middleware</h2><p>我們要想辦法在 <code>ProtocolTypeRouter</code> 呼叫 <code>URLRouter</code> 前，想辦法抓住這個錯誤，回傳正確找不到路徑的回傳，並且寫下 Log，為此，我們參考 <code>Django Channels</code> 的 <code>Middleware</code> ，它通常被包在 <code>URLRouter</code> 外層，在 <code>consumer</code> 前後處理 <code>scope</code>，並參考其實做方法，最後自己刻一個專門處理此問題的 <code>Middleware</code>。</p><h3 id=how-django-channels-middlewares-work>How Django Channels middlewares work</h3><p>首先我們可以看到 <code>Django Channels</code> 的 <code>BaseMiddleware</code> 在 <code>__init__</code> 時，只是把它傳來的值放進 <code>inner</code> 這個變數，在被呼叫時 (<code>__call__</code>) 回傳一個可以接受 <code>receive</code> 和 <code>send</code> 的異步函數，這個函數會在連線近來時被建立，且將 <code>receive</code> 和 <code>send</code> 被丟入 <code>epoll</code> 監聽的事件內，供異步伺服器和 client 溝通。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseMiddleware</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, inner):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Middleware constructor - just takes inner application.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>inner <span style=color:#f92672>=</span> inner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self, scope):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ASGI constructor; can insert things into the scope, but not
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        run asynchronous code.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Copy scope to stop changes going upstream</span>
</span></span><span style=display:flex><span>        scope <span style=color:#f92672>=</span> dict(scope)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Allow subclasses to change the scope</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>populate_scope(scope)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Call the inner application&#39;s init</span>
</span></span><span style=display:flex><span>        inner_instance <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>inner(scope)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Partially bind it to our coroutine entrypoint along with the scope</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> partial(self<span style=color:#f92672>.</span>coroutine_call, inner_instance, scope)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>coroutine_call</span>(self, inner_instance, scope, receive, send):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ASGI coroutine; where we can resolve items in the scope
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        (but you can&#39;t modify it at the top level here!)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>resolve_scope(scope)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> inner_instance(receive, send)
</span></span></code></pre></div><h1 id=ps>PS</h1><p>以上程式我也回在 <a href=https://github.com/django/daphne/issues/165#issuecomment-577024577>GitHub issue</a> 上，有任何更好的建議也希望您能發出來，幫助大家。</p><ul class=pa0><li class="list di"><a href=/tags/django/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">django</a></li><li class="list di"><a href=/tags/django-channels/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Django Channels</a></li><li class="list di"><a href=/tags/middleware/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Middleware</a></li></ul><div class="mt6 instapaper_ignoref"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-khfo0axv59.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/blog/create-a-gin-index-with-django-on-aws-rds/>Create a GIN index with Django on AWS RDS</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=/>&copy; Lambda 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>