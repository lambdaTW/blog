<!doctype html><html><head><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"\/"},"articleSection":"blog","name":"Create a GIN index with Django on AWS RDS","headline":"Create a GIN index with Django on AWS RDS","description":"GIN What is it GIN 是一種 INDEX 可以幫助加速全文搜索的速度\n GIN stands for Generalized Inverted Index. GIN is designed for handling cases where the items to be indexed are composite values, and the queries to be handled by the index need to search for element values that appear within the composite items. For example, the items could be documents, and the queries could be searches for documents containing specific words.\n Normal SQL 在傳統 SQL 下可以用以下幾個步驟完成建立 GIN INDEX","inLanguage":"en","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2019","datePublished":"2019-04-26 00:00:00 \x2b0000 UTC","dateModified":"2019-04-26 00:00:00 \x2b0000 UTC","url":"\/blog\/create-a-gin-index-with-django-on-aws-rds\/","wordCount":"686","keywords":["Index","postgres","Django","AWS","RDS","Blog"]}</script><title>Create a GIN index with Django on AWS RDS</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.68.3"><meta name=author content="lambda@lambda.tw"><meta name=description content="This blog is about Python, Golang, Django, IT etc."><meta name=twitter:card content="summary"><meta name=twitter:title content="Create a GIN index with Django on AWS RDS"><meta name=twitter:description content="GIN What is it GIN 是一種 INDEX 可以幫助加速全文搜索的速度
 GIN stands for Generalized Inverted Index. GIN is designed for handling cases where the items to be indexed are composite values, and the queries to be handled by the index need to search for element values that appear within the composite items. For example, the items could be documents, and the queries could be searches for documents containing specific words.
 Normal SQL 在傳統 SQL 下可以用以下幾個步驟完成建立 GIN INDEX"><meta property="og:title" content="Create a GIN index with Django on AWS RDS"><meta property="og:description" content="GIN What is it GIN 是一種 INDEX 可以幫助加速全文搜索的速度
 GIN stands for Generalized Inverted Index. GIN is designed for handling cases where the items to be indexed are composite values, and the queries to be handled by the index need to search for element values that appear within the composite items. For example, the items could be documents, and the queries could be searches for documents containing specific words.
 Normal SQL 在傳統 SQL 下可以用以下幾個步驟完成建立 GIN INDEX"><meta property="og:type" content="article"><meta property="og:url" content="/blog/create-a-gin-index-with-django-on-aws-rds/"><meta property="article:published_time" content="2019-04-26T00:00:00+00:00"><meta property="article:modified_time" content="2019-04-26T00:00:00+00:00"><meta property="og:image" content="//images/logo.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="512"><meta property="og:image:height" content="512"><meta itemprop=name content="Create a GIN index with Django on AWS RDS"><meta itemprop=description content="GIN What is it GIN 是一種 INDEX 可以幫助加速全文搜索的速度
 GIN stands for Generalized Inverted Index. GIN is designed for handling cases where the items to be indexed are composite values, and the queries to be handled by the index need to search for element values that appear within the composite items. For example, the items could be documents, and the queries could be searches for documents containing specific words.
 Normal SQL 在傳統 SQL 下可以用以下幾個步驟完成建立 GIN INDEX"><meta itemprop=datePublished content="2019-04-26T00:00:00+00:00"><meta itemprop=dateModified content="2019-04-26T00:00:00+00:00"><meta itemprop=wordCount content="686"><meta itemprop=keywords content="Index,postgres,Django,AWS,RDS,"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/add-on.css><link rel=stylesheet href=/css/academicons.min.css><link href=//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css rel=stylesheet type=text/css></head><body><div id=wrapper><header id=header><h1><a href=/>blog</a></h1><nav class=links><ul><li><a href=/><i class="fa fa-home">&nbsp;</i>Home</a></li><li><a href=/blog/><i class="fa fa-newspaper-o">&nbsp;</i>Blog</a></li><li><a href=/categories/><i class="fa fa-sitemap">&nbsp;</i>Categories</a></li></ul></nav><nav class=main><ul><li id=share-nav class=share-menu style=display:none><a class=fa-share-alt href=#share-menu>Share</a></li><li class=search><a class=fa-search href=#search>Search</a><form id=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=/></form></li><li class=menu><a class=fa-bars href=#menu>Menu</a></li></ul></nav></header><section id=menu><section><form class=search method=get action=//google.com/search><input type=text name=q placeholder=Search>
<input type=hidden name=as_sitesearch value=/></form></section><section><ul class=links><li><a href=/><h3><i class="fa fa-home">&nbsp;</i>Home</h3></a></li><li><a href=/blog/><h3><i class="fa fa-newspaper-o">&nbsp;</i>Blog</h3></a></li><li><a href=/categories/><h3><i class="fa fa-sitemap">&nbsp;</i>Categories</h3></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><article class=mini-post><header><h3><a href=/blog/python-project-5/>Python Project (5) Make Automatically</a></h3><time class=published datetime=2021-04-27>April 27, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-4/>Python Project (4) Test More</a></h3><time class=published datetime=2021-04-25>April 25, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-3/>Python Project (3) Test Your Project</a></h3><time class=published datetime=2021-04-24>April 24, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-2/>Python Project (2) Lint Your Project</a></h3><time class=published datetime=2021-04-23>April 23, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-1/>Python Project (1) setup.py setup.cfg</a></h3><time class=published datetime=2021-04-22>April 22, 2021</time></header></article><a href=/blog/ class=button>View more posts</a></div></section></section><section id=share-menu><section id=social-share-nav><ul class=links><header><h3>Share this post <i class="fa fa-smile-o"></i></h3></header><li><a href="//twitter.com/share?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&text=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS&via=" target=_blank class="share-btn twitter"><i class="fa fa-twitter"></i><p>Twitter</p></a></li><li><a href="//plus.google.com/share?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn google-plus"><i class="fa fa-google-plus"></i><p>Google+</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn facebook"><i class="fa fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn reddit"><i class="fa fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn linkedin"><i class="fa fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="//www.stumbleupon.com/submit?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn stumbleupon"><i class="fa fa-stumbleupon"></i><p>StumbleUpon</p></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&description=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn pinterest"><i class="fa fa-pinterest-p"></i><p>Pinterest</p></a></li><li><a href="mailto:?subject=Check out this post by lambda%40lambda.tw&body=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn email"><i class="fa fa-envelope"></i><p>Email</p></a></li></ul></section></section><div id=main><article class=post><header><div class=title><h1><a href=/blog/create-a-gin-index-with-django-on-aws-rds/>Create a GIN index with Django on AWS RDS</a></h1></div><div class=meta><time class=published datetime=2019-04-26>April 26, 2019</time>
<span class=author>lambda@lambda.tw</span><p>4 minute read</p></div></header><section id=social-share><ul class=icons><li><a href="//twitter.com/share?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&text=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS&via=" target=_blank class="share-btn twitter"><i class="fa fa-twitter"></i><p>Twitter</p></a></li><li><a href="//plus.google.com/share?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn google-plus"><i class="fa fa-google-plus"></i><p>Google+</p></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn facebook"><i class="fa fa-facebook"></i><p>Facebook</p></a></li><li><a href="//reddit.com/submit?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn reddit"><i class="fa fa-reddit-alien"></i><p>Reddit</p></a></li><li><a href="//www.linkedin.com/shareArticle?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn linkedin"><i class="fa fa-linkedin"></i><p>LinkedIn</p></a></li><li><a href="//www.stumbleupon.com/submit?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&title=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn stumbleupon"><i class="fa fa-stumbleupon"></i><p>StumbleUpon</p></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f&description=Create%20a%20GIN%20index%20with%20Django%20on%20AWS%20RDS" target=_blank class="share-btn pinterest"><i class="fa fa-pinterest-p"></i><p>Pinterest</p></a></li><li><a href="mailto:?subject=Check out this post by lambda%40lambda.tw&body=%2fblog%2fcreate-a-gin-index-with-django-on-aws-rds%2f" target=_blank class="share-btn email"><i class="fa fa-envelope"></i><p>Email</p></a></li></ul></section><div id=content><h2 id=gin>GIN</h2><h3 id=what-is-it>What is it</h3><p>GIN 是一種 INDEX 可以幫助加速全文搜索的速度</p><blockquote><p>GIN stands for Generalized Inverted Index. GIN is designed for handling cases where the items to be indexed are composite values, and the queries to be handled by the index need to search for element values that appear within the composite items. For example, the items could be documents, and the queries could be searches for documents containing specific words.</p></blockquote><h3 id=normal-sql>Normal SQL</h3><p>在傳統 SQL 下可以用以下幾個步驟完成建立 GIN INDEX</p><ul><li>Install gin extension</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>EXTENSION</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> pg_trgm;</code></pre></div><ul><li>Create index for table&rsquo;s column<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#f92672>&lt;</span>index_name<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>ON</span> <span style=color:#f92672>&lt;</span>schema_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>.</span><span style=color:#f92672>&lt;</span>table_name<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>USING</span> gin
    (<span style=color:#f92672>&lt;</span>column_name<span style=color:#f92672>&gt;</span>)
    <span style=color:#66d9ef>TABLESPACE</span> pg_default;</code></pre></div></li></ul><h4 id=special-type>Special type</h4><p>但是如果你是特殊的欄位，例如：varchar、text，此時你就必須要給它特定的 operator 才能建立</p><h5 id=create-gin-index-for-varchar-column>Create GIN INDEX for varchar column</h5><ul><li>Use gin_trgm_ops as operator</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#f92672>&lt;</span>index_name<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>ON</span> <span style=color:#f92672>&lt;</span>schema_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>.</span><span style=color:#f92672>&lt;</span>table_name<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>USING</span> gin
    (<span style=color:#f92672>&lt;</span>column_name <span style=color:#66d9ef>COLLATE</span> pg_catalog<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;default&#34;</span> gin_trgm_ops)
    <span style=color:#66d9ef>TABLESPACE</span> pg_default;</code></pre></div><h5 id=or-you-can-set-gin_trgm_ops-as-default>Or, you can set <code>gin_trgm_ops</code> as default</h5><ul><li>Set default operator class</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>UPDATE</span> pg_opclass <span style=color:#66d9ef>SET</span> opcdefault <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>WHERE</span> opcname<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gin_trgm_ops&#39;</span>;</code></pre></div><ul><li>Create the index like other types of column</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#f92672>&lt;</span>index_name<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>ON</span> <span style=color:#f92672>&lt;</span>schema_name<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>.</span><span style=color:#f92672>&lt;</span>table_name<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>USING</span> gin
    (<span style=color:#f92672>&lt;</span>column_name<span style=color:#f92672>&gt;</span>)
    <span style=color:#66d9ef>TABLESPACE</span> pg_default;</code></pre></div><h3 id=use-django-postgres-contribution-library>Use Django Postgres contribution library</h3><p>對於 PostgreSQL 有較完善的 Django 對於 GIN INDEX 也是有支援的，所以你可以在 <code>models.py</code> 直接使用它</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#f92672>from</span> django.db <span style=color:#66d9ef>import</span> models
<span style=color:#f92672>from</span> django.contrib.postgres.fields <span style=color:#66d9ef>import</span> JSONField
<span style=color:#f92672>from</span> django.contrib.postgres.indexes <span style=color:#66d9ef>import</span> GinIndex


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Post</span>(models<span style=color:#f92672>.</span>Model):
    content_segment <span style=color:#f92672>=</span> JSONField(default<span style=color:#f92672>=</span>list)

    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
        indexes <span style=color:#f92672>=</span> [GinIndex(fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;content_segment&#39;</span>])]</code></pre></div><h3 id=the-char-field-in-django>The char field in Django</h3><p>在 Django 中 Char、Text 等 <code>varchar</code> 類型的欄位要使用 GIN 和原生 SQL 一樣需要去設定需要使用的 <code>operator</code>， 產出 migration file, 並且 migrate 以後你應該會看到類似下面的錯誤</p><pre><code>ERROR: data type character varying has no default operator class for access method &quot;gin&quot;
</code></pre><p>我們很簡單的可以在 Add Index 前加上設定 default operator 去 by pass</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#f92672>import</span> django.contrib.postgres.indexes
<span style=color:#f92672>from</span> django.db <span style=color:#66d9ef>import</span> migrations, models


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Migration</span>(migrations<span style=color:#f92672>.</span>Migration):

    dependencies <span style=color:#f92672>=</span> [
        (<span style=color:#e6db74>&#39;posts&#39;</span>, <span style=color:#e6db74>&#39;....&#39;</span>),
    ]

    operations <span style=color:#f92672>=</span> [
        migrations<span style=color:#f92672>.</span>RunSQL([
            <span style=color:#e6db74>&#34;UPDATE pg_opclass SET opcdefault = true WHERE opcname=&#39;gin_trgm_ops&#39;;&#34;</span>,
        ]),
        migrations<span style=color:#f92672>.</span>AddIndex(
            model_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;post&#39;</span>,
            index<span style=color:#f92672>=</span>django<span style=color:#f92672>.</span>contrib<span style=color:#f92672>.</span>postgres<span style=color:#f92672>.</span>indexes<span style=color:#f92672>.</span>GinIndex(fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;title&#39;</span>], name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;posts_po_title_374d31_gin&#39;</span>),
        )
    ]</code></pre></div><p>你應該會看到下面的錯誤</p><pre><code>django.db.utils.ProgrammingError: operator class &quot;gin_trgm_ops&quot; does not exist for access method &quot;gin&quot;
</code></pre><p>表示你家的 PostgreSQL 沒有安裝 GIN 的套件，這很簡單，只需要改改 migration file 就好</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#f92672>import</span> django.contrib.postgres.indexes
<span style=color:#f92672>from</span> django.db <span style=color:#66d9ef>import</span> migrations, models


<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Migration</span>(migrations<span style=color:#f92672>.</span>Migration):

    dependencies <span style=color:#f92672>=</span> [
        (<span style=color:#e6db74>&#39;posts&#39;</span>, <span style=color:#e6db74>&#39;....&#39;</span>),
    ]

    operations <span style=color:#f92672>=</span> [
        migrations<span style=color:#f92672>.</span>RunSQL([
            <span style=color:#e6db74>&#34;CREATE EXTENSION IF NOT EXISTS pg_trgm;&#34;</span>,
            <span style=color:#e6db74>&#34;UPDATE pg_opclass SET opcdefault = true WHERE opcname=&#39;gin_trgm_ops&#39;;&#34;</span>
        ]),
        migrations<span style=color:#f92672>.</span>AddIndex(
            model_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;post&#39;</span>,
            index<span style=color:#f92672>=</span>django<span style=color:#f92672>.</span>contrib<span style=color:#f92672>.</span>postgres<span style=color:#f92672>.</span>indexes<span style=color:#f92672>.</span>GinIndex(fields<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;title&#39;</span>], name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;posts_po_title_374d31_gin&#39;</span>),
        )
    ]</code></pre></div><p>再次 migrate 相信你已經成功了</p><h2 id=aws-rds-is-secure-than-your-local-db-server>AWS RDS is secure than your local DB server</h2><p>AWS RDS 預設不會給你 superuser 權限，所以你沒有辦法直接執行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=color:#66d9ef>UPDATE</span> pg_opclass <span style=color:#66d9ef>SET</span> opcdefault <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>WHERE</span> opcname<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gin_trgm_ops&#39;</span>;</code></pre></div><p>這會讓你在 Django migrate 時看到以下錯誤</p><pre><code>permission denied for relation pg_opclass
</code></pre><h3 id=fix-it>Fix it</h3><p>記得我們在最一開始如何使用免設定預設 <code>operator</code> 就產生了一個 GIN 的 index 嗎？</p><p>如法炮製我們直接把 <code>operator</code> 插入在 CREATE INDEX 的 SQL 就可以達到了</p><h4 id=source-code-tour>Source code tour</h4><ul><li>GINIndex forefathers
我們可以在發現 SQL statement 是由 <code>schema_editor</code> 的 <code>_create_index_sql</code> 產生出來的</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3>  <span style=color:#75715e># django/contrib/postgres/indexes.py</span>
  <span style=color:#f92672>from</span> django.db.models <span style=color:#66d9ef>import</span> Index


  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PostgresIndex</span>(Index):
      <span style=color:#75715e># ...</span>


  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GinIndex</span>(PostgresIndex):
      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_sql</span>(self, model, schema_editor, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>):
          statement <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>create_sql(model, schema_editor, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39; USING </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> self<span style=color:#f92672>.</span>suffix)
          with_params <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>get_with_params()
          <span style=color:#66d9ef>if</span> with_params:
              statement<span style=color:#f92672>.</span>parts[<span style=color:#e6db74>&#39;extra&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;WITH (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>) </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> (
                  <span style=color:#e6db74>&#39;, &#39;</span><span style=color:#f92672>.</span>join(with_params),
                  statement<span style=color:#f92672>.</span>parts[<span style=color:#e6db74>&#39;extra&#39;</span>],
              )
          <span style=color:#66d9ef>return</span> statement


  <span style=color:#75715e># django/db/models/indexes.py</span>
  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Index</span>:
      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_sql</span>(self, model, schema_editor, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>):
          fields <span style=color:#f92672>=</span> [model<span style=color:#f92672>.</span>_meta<span style=color:#f92672>.</span>get_field(field_name) <span style=color:#66d9ef>for</span> field_name, _ <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>fields_orders]
          col_suffixes <span style=color:#f92672>=</span> [order[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>for</span> order <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>fields_orders]
          <span style=color:#66d9ef>return</span> schema_editor<span style=color:#f92672>.</span>_create_index_sql(
              model, fields, name<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>name, using<span style=color:#f92672>=</span>using, db_tablespace<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>db_tablespace,
              col_suffixes<span style=color:#f92672>=</span>col_suffixes,
          )</code></pre></div><ul><li>How <code>schema_edit</code> create SQL statement</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3>  <span style=color:#75715e># django/db/backends/postgresql/schema.py</span>
  <span style=color:#f92672>from</span> django.db.backends.base.schema <span style=color:#66d9ef>import</span> BaseDatabaseSchemaEditor


  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseSchemaEditor</span>(BaseDatabaseSchemaEditor):
      <span style=color:#75715e># ...</span>
      sql_create_index <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CREATE INDEX </span><span style=color:#e6db74>%(name)s</span><span style=color:#e6db74> ON </span><span style=color:#e6db74>%(table)s%(using)s</span><span style=color:#e6db74> (</span><span style=color:#e6db74>%(columns)s</span><span style=color:#e6db74>)</span><span style=color:#e6db74>%(extra)s</span><span style=color:#e6db74>&#34;</span>


  <span style=color:#75715e># schema.py</span>
  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseDatabaseSchemaEditor</span>:
      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_create_index_sql</span>(self, model, fields, <span style=color:#f92672>*</span>, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
                            db_tablespace<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, col_suffixes<span style=color:#f92672>=</span>(), sql<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
          <span style=color:#e6db74>&#34;&#34;&#34;
</span><span style=color:#e6db74>          Return the SQL statement to create the index for one or several fields.
</span><span style=color:#e6db74>          `sql` can be specified if the syntax differs from the standard (GIS
</span><span style=color:#e6db74>          indexes, ...).
</span><span style=color:#e6db74>          &#34;&#34;&#34;</span>
          tablespace_sql <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_get_index_tablespace_sql(model, fields, db_tablespace<span style=color:#f92672>=</span>db_tablespace)
          columns <span style=color:#f92672>=</span> [field<span style=color:#f92672>.</span>column <span style=color:#66d9ef>for</span> field <span style=color:#f92672>in</span> fields]
          sql_create_index <span style=color:#f92672>=</span> sql <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>sql_create_index
          table <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>_meta<span style=color:#f92672>.</span>db_table

          <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_index_name</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
              <span style=color:#66d9ef>nonlocal</span> name
              <span style=color:#66d9ef>if</span> name <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
                  name <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_create_index_name(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
              <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>quote_name(name)

          <span style=color:#66d9ef>return</span> Statement(
              sql_create_index,
              table<span style=color:#f92672>=</span>Table(table, self<span style=color:#f92672>.</span>quote_name),
              name<span style=color:#f92672>=</span>IndexName(table, columns, suffix, create_index_name),
              using<span style=color:#f92672>=</span>using,
              columns<span style=color:#f92672>=</span>Columns(table, columns, self<span style=color:#f92672>.</span>quote_name, col_suffixes<span style=color:#f92672>=</span>col_suffixes),
              extra<span style=color:#f92672>=</span>tablespace_sql,
          )</code></pre></div><ul><li>Override the <code>create_sql</code></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3>  <span style=color:#f92672>from</span> django.contrib.postgres.indexes <span style=color:#66d9ef>import</span> GinIndex


  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CharGinIndex</span>(GinIndex):

      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_sql</span>(self, model, schema_editor, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>):
          <span style=color:#66d9ef>assert</span> len(self<span style=color:#f92672>.</span>fields_orders) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
          original_sql <span style=color:#f92672>=</span> schema_editor<span style=color:#f92672>.</span>sql_create_index
          schema_editor<span style=color:#f92672>.</span>sql_create_index <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CREATE INDEX </span><span style=color:#e6db74>%(name)s</span><span style=color:#e6db74> ON </span><span style=color:#e6db74>%(table)s%(using)s</span><span style=color:#e6db74> (</span><span style=color:#e6db74>%(columns)s</span><span style=color:#e6db74> COLLATE pg_catalog.&#34;default&#34; gin_trgm_ops)</span><span style=color:#e6db74>%(extra)s</span><span style=color:#e6db74>&#39;</span>
          statement <span style=color:#f92672>=</span> super()<span style=color:#f92672>.</span>create_sql(model, schema_editor, using)
          schema_editor<span style=color:#f92672>.</span>sql_create_index <span style=color:#f92672>=</span> original_sql
          <span style=color:#66d9ef>return</span> statement</code></pre></div><p>我們在 <code>create_sql</code> 上面覆寫掉 <code>schema_editor</code> 的 <code>sql_create_index</code> 語法，並且在呼叫完 <code>create_sql</code> 以後把它還原（因為一次 migrate 中 schema editor 會被重複使用，若沒有還原其他在同一次 migrate 中使用到相同 schema editor 的就會被影響)</p><h2 id=conclusion>Conclusion</h2><p>在這邊用比較髒的方式處理了這個問題，主要是因為在 <code>BaseDatabaseSchemaEditor</code> 有以下方式可以更改 <code>sql</code> 參數就可以達到這功能，但是在 <code>Index</code> 類別並沒有把此參數讓我們可以丟進去，由於不會影響功能，暫時就不重複造輪子。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BaseDatabaseSchemaEditor</span>:
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_create_index_sql</span>(self, model, fields, <span style=color:#f92672>*</span>, name<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, suffix<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, using<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
                          db_tablespace<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, col_suffixes<span style=color:#f92672>=</span>(), sql<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
		<span style=color:#75715e># ...</span>
        sql_create_index <span style=color:#f92672>=</span> sql <span style=color:#f92672>or</span> self<span style=color:#f92672>.</span>sql_create_index
		<span style=color:#75715e># ...</span></code></pre></div></div><footer><ul class=stats><li class=categories><ul><i class="fa fa-folder"></i><li><a class=article-category-link href=/categories/django>Django</a></li></ul></li><li class=tags><ul><i class="fa fa-tags"></i><li><a class=article-category-link href=/tags/index>Index</a></li><li><a class=article-category-link href=/tags/postgres>postgres</a></li><li><a class=article-category-link href=/tags/django>Django</a></li><li><a class=article-category-link href=/tags/aws>AWS</a></li><li><a class=article-category-link href=/tags/rds>RDS</a></li></ul></li></ul></footer></article><article class=post><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"blog-khfo0axv59"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article><ul class="actions pagination"><li><a href=/blog/closure/ class="button big previous">Closure</a></li><li><a href=/blog/how-to-fix-no-route-found-error-on-django-channels/ class="button big next">How to fix no route found error on Django Channels</a></li></ul></div><section id=sidebar><section id=intro><header><h2>LAMBDA</h2><p>I AM LAMBDA</p></header><ul class=icons><li><a href=/index.xml type=application/rss+xml target=_blank title=RSS class="fa fa-rss"></a></li><li><a href=//github.com/lambdaTW target=_blank title=GitHub class="fa fa-github"></a></li><li><a href=//gitlab.com/lambdaTW target=_blank title=GitLab class="fa fa-gitlab"></a></li><li><a href=mailto:lambda@lambda.tw title=Email class="fa fa-envelope"></a></li></ul></section><section class=recent-posts><div class=mini-posts><header><h3>Recent Posts</h3></header><div class=posts-container><article class=mini-post><header><h3><a href=/blog/python-project-5/>Python Project (5) Make Automatically</a></h3><time class=published datetime=2021-04-27>April 27, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-4/>Python Project (4) Test More</a></h3><time class=published datetime=2021-04-25>April 25, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-3/>Python Project (3) Test Your Project</a></h3><time class=published datetime=2021-04-24>April 24, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-2/>Python Project (2) Lint Your Project</a></h3><time class=published datetime=2021-04-23>April 23, 2021</time></header></article><article class=mini-post><header><h3><a href=/blog/python-project-1/>Python Project (1) setup.py setup.cfg</a></h3><time class=published datetime=2021-04-22>April 22, 2021</time></header></article></div><a href=/blog/ class=button>View more posts</a></div></section><section id=categories><header><h3><a href=/categories/>Categories</a></h3></header><p><article><header><a href=/categories/python/>python</a>
<span style=float:right>6</span></header></article></p><p><article><header><a href=/categories/golang/>golang</a>
<span style=float:right>5</span></header></article></p><p><article><header><a href=/categories/project/>project</a>
<span style=float:right>5</span></header></article></p><p><article><header><a href=/categories/django/>django</a>
<span style=float:right>2</span></header></article></p><p><article><header><a href=/categories/test/>test</a>
<span style=float:right>2</span></header></article></p><p><article><header><a href=/categories/grpc/>grpc</a>
<span style=float:right>1</span></header></article></p><p><article><header><a href=/categories/middleware/>middleware</a>
<span style=float:right>1</span></header></article></p></section><section id=mini-bio><h3>About</h3><p>This blog show everything</p><a href=/about/ class=button>Learn More</a></section><section id=footer><ul class=icons><li><a href=/index.xml type=application/rss+xml target=_blank title=RSS class="fa fa-rss"></a></li><li><a href=//github.com/lambdaTW target=_blank title=GitHub class="fa fa-github"></a></li><li><a href=//gitlab.com/lambdaTW target=_blank title=GitLab class="fa fa-gitlab"></a></li><li><a href=mailto:lambda@lambda.tw title=Email class="fa fa-envelope"></a></li></ul><p class=copyright>&copy; 2021
Lambda
.
Powered by <a href=//gohugo.io target=_blank>Hugo</a></p></section></section></div><a id=back-to-top href=# class="fa fa-arrow-up fa-border fa-2x"></a><script src=//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.11.0/languages/css.min.js></script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><script src=https://code.jquery.com/jquery-3.2.1.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js></script><script src=/js/util.js></script><script src=/js/main.js></script><script src=/js/backToTop.js></script><script>hljs.initHighlightingOnLoad();</script><script src=//yihui.name/js/math-code.js></script><script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>